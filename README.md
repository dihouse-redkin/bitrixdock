# Bitrix Docker


**Этот проект для использования на тестовых машинах для разработки функционала.
Он корявый и дырявый, поэтому не может использоваться на PRODUCTION серверах!**

Проект является форком проекта BitrixDock. Вся исходная документация здесь:

[- GitHub проекта BitrixDock](https://github.com/bitrixdock/bitrixdock)


### Преимущества данной сборки
- Сервис PHP запакован в отдельный образ, чтобы избавить разработчиков от долгого компилирования.
- Остальные сервисы так же "причёсаны" и разворачиваются моментально.
- Ничего лишнего.
- Вместо CentOS используется Ubuntu

## Как установить

На машине с UBUNTU необходимо в первую очередь отредактировать файл hosts, чтобы направить доменные имена на машину с докером

```bash
# Пример файла etc/hosts
# Просто добавляем в начало список всех доменов, 
# которые хотим использовать на этой машине
127.0.0.1	localhost
127.0.0.1	docker3.di-house.tech
127.0.0.1	docker4.di-house.tech

# The following lines are desirable for IPv6 capable hosts
::1	ip6-localhost	ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
ff02::3	ip6-allhosts
127.0.1.1	miezxjlvif	miezxjlvif

```


#### Затем необходимо запустить скрипт в BASH

```
curl -fsSL https://raw.githubusercontent.com/dihouse-redkin/bitrixdock/master/install.sh -o install.sh && chmod +x install.sh && sh install.sh
```

#### Для правильной работы необходимо иницилизировать первый сайт
```bash
# в папке var/www/bitrixdock/ выполнить команду
> ./init_main_site.sh

# будет запрошено имя домена основного сайта
# введите первый домен
> docker-main.di-house.tech

# будет выведено сообщение DONE!
```

#### Затем необходимо собрать Docker, чтобы правильно встали конфиги NGINX

```bash
# там же в папке в папке var/www/bitrixdock/
# команда говорит "Собери все образы докера по-братски"
> docker-compose build

# процедура займет 1-2 минуты
```

Если не будет ошибок, то можно будет поднять докер

```bash
# там же в папке в папке var/www/bitrixdock/
# команда говорит "Запусти все образы докера в режиме демона (-d)"
> docker-compose up -d

# Если всё будет ок, то будут отображаться такие сообщения 
# Creating bitrixdock_source_1 ... done
# Creating bitrixdock_memcached_1 ... done
# Creating bitrixdock_db_1        ... done
# Creating bitrixdock_adminer_1   ... done
# Creating bitrixdock_php_1       ... done
# Creating bitrixdock_web_server_1 ... done
```

### Всё! Можно работать!

В папке var/www/sites/**domain-name** уже лежит установочный файл Битрикса. Его можно удалить и использовать любое PHP приложение. 

Этого хватит на создание одного тестового сайта. 
Чтобы создать новый тестовй сайт, необходимо выполнить следующие шаги. 

#### Выключить докер
```bash
> docker-compose down
```

#### Создать новый сайт

```bash 
# там же в папке в папке var/www/bitrixdock/
# команда говорит "Запусти все образы докера в режиме демона (-d)"
> ./create_site.sh

# Вам будет предложено ввести имя домена нового сайта

> docker2.di-house.tech

# Done!
```

#### Таким образом будут созданы новые конфиги NGINX и создана папка для нового сайта

#### Далее необходимо заново собрать образ докера и запустить его

```bash
> docker-compose build
> docker-compose up -d
```

### Всё! Можно пользоваться!


## Важные нюансы

#### Как заполнять подключение к БД

При создании нового сайта на Битриксе необходимо вводить параметры подключения к БД.
Вместо Localhost необходимо написать **"db"**. 
Это имя сервера с базой данных в образах докера.

Настройки подключения вводить следующим образом

```bash
# Пользователь - root (иначе не будет возможности создавать новые базы)
# Пароль - rootroot
# Посмотреть настройки подключения можно в файле .env_template
```


#### ВАЖНО! 
При создании нового тестового сайта имя базы данных должно совпадать с доменом сайта, чтобы можно было легко их удалять и не путаться!

## Примечание
- По умолчанию стоит папка ```/var/www/имя главного домена/```
- В настройках подключения требуется указывать имя сервиса, например для подключения к базе нужно указывать "db", а не "localhost". Пример [конфига](configs/.settings.php) с подключением к mysql и memcached.
- Для загрузки резервной копии в контейнер используйте команду: ```cat /var/www/bitrix/backup.sql | docker exec -i mysql /usr/bin/mysql -u root -p123 bitrix```
- При использовании php74 в production удалите строку с `php7.4-xdebug` из файла `php74/Dockerfile`, сам факт его установки снижает производительность Битрикса и он должен использоваться только для разработки
- Многосайтовость пока что не поддерживается


## Использование xdebug.

- Настройки xdebug задаются в `phpXX/php.ini`.
- Для php73, php74 дефолтовые настройки xdebug - коннект на порт `9003` хоста, с которого пришел запрос. В случае невозможности коннекта - фаллбек на `host.docker.internal`.
- При изменении `php.ini` в проекте не забудьте добавить флаг `--build` при запуске `docker-compose`, чтобы форсировать пересборку имиджа.

